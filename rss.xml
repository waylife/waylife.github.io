<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title><![CDATA[RxRead's Blog]]></title>
    <link>http://blog.zanlabs.com/</link>
    <atom:link href="/rss.xml" rel="self" type="application/rss+xml"/>
    <description><![CDATA[关注Android、WP、Java、C#、自我认知、程序安全等]]></description>
    <pubDate>Fri, 04 Sep 2015 07:13:36 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title><![CDATA[Build aapt for windows]]></title>
      <link>http://blog.zanlabs.com/2015/09/04/build-aapt-for-windows/</link>
      <guid>http://blog.zanlabs.com/2015/09/04/build-aapt-for-windows/</guid>
      <pubDate>Fri, 04 Sep 2015 07:13:36 GMT</pubDate>
      <description>
      <![CDATA[<h1 id="Background">Background</h1><p>In order to practise my english, I am trying to writing some posts in english. So this article may con]]>
      </description>
      <content:encoded><![CDATA[<h1 id="Background">Background</h1><p>In order to practise my english, I am trying to writing some posts in english. So this article may confuse some people, I’m really sorry for that. By the way, if there some some typos, grammatical mistake and other mistakes, please feel free to point it out. I really appreciate it much. Thanks.</p>
<p>For some reasons, I decided to compile the appt from scratch.<br>Target: <strong>aapt for windows.</strong><br>Then I moved on.<br>However,It’s somehow ridiculous, if we want to  build aapt for windows we have to build it on linux according to the official manual.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Full Windows SDK builds are only supported on Linux -- most of the framework is not designed to be built on Windows so technically the Windows SDK is build on top of a Linux SDK <span class="built_in">where</span> a few binaries are replaced.</span><br><span class="line">http://tools.android.com/build</span><br></pre></td></tr></table></figure></p>
<p>It is said that Firefox for android also has to be built on *unix system. But it has nothing to do with this article.</p>
<h1 id="Steps">Steps</h1><p>Anyway, let’s do it step by step.</p>
<h2 id="Install_Linux">Install Linux</h2><p>First Install Linux 64 bit(important, other versions may be different with this post), I chose the  ubuntu-14.04.2-desktop.<br><a href="http://releases.ubuntu.com/14.04.2/ubuntu-14.04.2-desktop-amd64.iso.torrent" target="_blank" rel="external">http://releases.ubuntu.com/14.04.2/ubuntu-14.04.2-desktop-amd64.iso.torrent</a><br>I encountered the low screen resolution in Ubuntu, as installed it on a virtual machine. Eventually solved it through this link.<a href="http://www.linuxbsdos.com/2014/10/31/solutions-for-low-screen-resolution-in-ubuntu-14-0414-10-and-virtualbox/" target="_blank" rel="external">http://www.linuxbsdos.com/2014/10/31/solutions-for-low-screen-resolution-in-ubuntu-14-0414-10-and-virtualbox/</a></p>
<h2 id="Install_jdk">Install jdk</h2><p>Install Java 7: For the latest version of Android<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install openjdk-<span class="number">7</span>-jdk</span><br></pre></td></tr></table></figure></p>
<p>Optionally, update the default Java version by running:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-alternatives --config java</span><br><span class="line">$ sudo update-alternatives --config javac</span><br></pre></td></tr></table></figure></p>
<h2 id="Install_some_necessary_tools">Install some necessary tools</h2><p>Install some other necessary tools.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install bison g++-multilib git gperf libxml2-utils make python-networkx zlib1g-dev:i386 zip</span><br></pre></td></tr></table></figure></p>
<p>Something wrong happens.<br><em>The following packages have unmet dependencies:<br> g++-multilib : Depends: gcc-multilib (&gt;= 4:4.8.2-1ubuntu6) but it is not going to be installed<br>                Depends: g++ (&gt;= 4:4.8.2-1ubuntu6) but it is not going to be installed<br>E: Unable to correct problems, you have held broken packages.</em><br><a href="http://www.cnblogs.com/wanyuanchun/p/3738938.html" target="_blank" rel="external">http://www.cnblogs.com/wanyuanchun/p/3738938.html</a></p>
<p>So intall gcc-multilib and g++ first.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install gcc-multilib g++</span><br></pre></td></tr></table></figure></p>
<h2 id="Install_repo_and_download_source">Install repo and download source</h2><p>Install repo to download source<br><a href="http://source.android.com/source/downloading.html#installing-repo" target="_blank" rel="external">http://source.android.com/source/downloading.html#installing-repo</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/bin</span><br><span class="line">$ PATH=~/bin:<span class="variable">$PATH</span></span><br><span class="line">$ curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">$ chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure></p>
<p>config git  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global user.email <span class="string">"you@example.com"</span></span><br><span class="line">$ git config --global user.name <span class="string">"Your Name"</span></span><br></pre></td></tr></table></figure>
<p>init source<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/android</span><br><span class="line">$ repo init -u https://android.googlesource.com/platform/manifest -b master -g all,-notdefault,tools</span><br></pre></td></tr></table></figure></p>
<p>For guys in mainland China, you should try the command below, for two reason one is  Google is blocked ,the other is it more faster.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo init -u git://aosp.tuna.tsinghua.edu.cn/android/platform/manifest -b master -g all,-notdefault,tools</span><br></pre></td></tr></table></figure></p>
<p>Then start the downloading.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo sync</span><br></pre></td></tr></table></figure></p>
<p>And wait for the downloading to end, about 33G when the time I downloaded it.<br><img src="https://github.com/waylife/blogimage/raw/master/2015/08/01/android_sdk_source_count.png" alt="source size"><br>So better downloaded at night, then have a good sleep. When the time you wake up, things is ready.  </p>
<h2 id="Install_mingw32">Install mingw32</h2><p>For the build of windows’ exe and dll files.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install mingw32 tofrodos</span><br></pre></td></tr></table></figure></p>
<h2 id="Compile_the_source">Compile the source</h2><p>When source downloaded, we can compile it now.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/android</span><br><span class="line">$ . build/envsetup.sh</span><br><span class="line">$ lunch sdk-eng</span><br><span class="line">$ make win_sdk</span><br></pre></td></tr></table></figure></p>
<p>Note that this will build both a Linux SDK and a Windows SDK.<br>The result is located at out/host/windows/sdk/android-sdk_eng.${USER}_windows/<br>If you encounter error,<em>“error while loading shared libraries: libncurses.so.5”. </em><br>Install lib32ncurses5, then use make win_sdk to build it again.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install lib32ncurses5</span><br></pre></td></tr></table></figure></p>
<p>Later I got  another error when building libwebviewchromium.<br><em>“collect2: error: ld terminated with signal 9 [Killed]<br>make: **</em> [out/target/product/generic/obj/SHA-j4 win-sdkRED_LIBRARIES/libwebviewchromium_intermediates/LINKED/libwebviewchromium.so] Error 1 “*<br>This because the system do not have a swap file.    Let’s create it.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/swapfile bs=<span class="number">1</span>G count=<span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>Verify that file has been created on the server:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls -lh /swapfile</span><br></pre></td></tr></table></figure></p>
<p>Type the following chmod command and chown command to secure and set correct file permission for security reasons.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:root /swapfile</span><br><span class="line">sudo chmod <span class="number">0600</span> /swapfile</span><br></pre></td></tr></table></figure></p>
<p>Turn on the swap file<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkswap /swapfile</span><br><span class="line">sudo swapon /swapfile</span><br></pre></td></tr></table></figure></p>
<p>Verify new swap file and settings on Ubuntu<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon <span class="operator">-s</span></span><br></pre></td></tr></table></figure></p>
<p>Now we can build the window sdk.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make win_sdk</span><br></pre></td></tr></table></figure></p>
<p>After some hours, which depends on your machine, all things will finish.<br>We can get appt.exe from the out folder.  </p>
<p>If ou  only want to compile some tools, not all of them.<br>Just Do below.<br>For linux:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make aapt</span><br></pre></td></tr></table></figure></p>
<p>For windows(Please execute make aapt first to generate some libraries):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo USE_MINGW=<span class="number">1</span> make aapt</span><br></pre></td></tr></table></figure></p>
<h1 id="More">More</h1><p>For custom needs, you can modify the source and rebuild it.<br>Due to NDA(Non-Disclosure Agreement), I skip this chapter.  </p>
<h1 id="References">References</h1><ul>
<li><a href="http://www.timelesssky.com/blog/building-android-sdk-build-tools-aapt-for-debian-arm" target="_blank" rel="external">http://www.timelesssky.com/blog/building-android-sdk-build-tools-aapt-for-debian-arm</a></li>
<li><a href="http://source.android.com/source/initializing.html#choosing-a-branch" target="_blank" rel="external">http://source.android.com/source/initializing.html#choosing-a-branch</a></li>
<li><a href="https://android.googlesource.com/platform/sdk/+/master/docs/howto_build_SDK.txt" target="_blank" rel="external">https://android.googlesource.com/platform/sdk/+/master/docs/howto_build_SDK.txt</a></li>
<li><a href="http://tools.android.com/build" target="_blank" rel="external">http://tools.android.com/build</a></li>
<li><a href="http://source.android.com/source/using-repo.html" target="_blank" rel="external">http://source.android.com/source/using-repo.html</a></li>
<li><a href="http://www.cyberciti.biz/faq/ubuntu-linux-create-add-swap-file/" target="_blank" rel="external">http://www.cyberciti.biz/faq/ubuntu-linux-create-add-swap-file/</a></li>
</ul>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2015/09/04/build-aapt-for-windows/#disqus_thread</comments>
    </item>
    
    <item>
      <title><![CDATA[Android桌面快捷方式那些事与那些坑]]></title>
      <link>http://blog.zanlabs.com/2015/03/14/android-shortcut-summary/</link>
      <guid>http://blog.zanlabs.com/2015/03/14/android-shortcut-summary/</guid>
      <pubDate>Sat, 14 Mar 2015 08:22:45 GMT</pubDate>
      <description>
      <![CDATA[<p>将近二个多月没写博客了。<br>之前一段时间一直在搞红包助手，就没抽时间写博客，但写这个真的是很好玩。没想到居然在Android上实现模拟点击，从而实现自动抢红包，有兴趣的同学可以参考<a href="https://github.com/waylife/RedEnvelo]]>
      </description>
      <content:encoded><![CDATA[<p>将近二个多月没写博客了。<br>之前一段时间一直在搞红包助手，就没抽时间写博客，但写这个真的是很好玩。没想到居然在Android上实现模拟点击，从而实现自动抢红包，有兴趣的同学可以参考<a href="https://github.com/waylife/RedEnvelopeAssistant" target="_blank" rel="external">https://github.com/waylife/RedEnvelopeAssistant</a> ,代码已经开源。<br>红包助手还有一些问题，但是现在基本的抢红包基本没问题了。目前正在对它进行优化以及较低版本的一些适配，还有项目的国际化工作。<br>废话不多说了，下面是Andrioid开发过程中快捷方式相关的事与坑。<br>数据来源于上次组内自己的CodeReview总结。</p>
<h1 id="背景">背景</h1><p>一般情况下，为了让用户更方便的打开应用，程序会在桌面上生成一些快捷方式。<br>本来呢，如果是原生的桌面，其实是十分简单，直接调用系统相关的API就行了。但是众多的系统厂商以及众多第三方自己定制的桌面（Launcher），导致在适配、兼容方面存在很多问题。<br>比如，有些桌面无法删除快捷方式（比如小米），有些桌面无法生成快捷方式（比如锤子），有些系统无法更新桌面图标（比如华为荣耀6）。<br>在升级、降级的时候快捷方式发生变化；比如，全部变成应用的主图标，升级、降级后点击快捷方式没有反应，删除应用后无法删除快捷方式。<br>很多问题都是需要解决的，虽然有些由于系统限制，没有办法搞定所有的，但是仍然需要寻求一个最优的方案。这也就是本文需要讨论的问题。<br>本文说指的快捷方式是指应用桌面快捷方式，不包含长按弹出的生成快捷方式。<br>快捷方式所有信息都是存在于launcher的favorite表。一般需要用到的字段为_id,title,intent,iconResource,icon，分别表示 快捷方式名称，快捷方式intent，快捷方式图标（本地），快捷方式图标（data二进制压缩数据）。<br>两个intent数据如下<br><img src="https://github.com/waylife/blogimage/raw/master/2015/03/14/shorcut_intent.png" alt=" "><br>数据可以通过SQLite Editor查看，需要已经ROOT的手机  </p>
<h1 id="实现">实现</h1><h2 id="增加快捷方式">增加快捷方式</h2><p>在AndroidManifest.xml增加权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.INSTALL_SHORTCUT"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>同时，根据Intent是隐式还是显示在相关的Activity声明相关的intent-filter。<br>相关代码：<br><img src="https://github.com/waylife/blogimage/raw/master/2015/03/14/shortcut_add.jpg" alt=" "><br><img src="https://github.com/waylife/blogimage/raw/master/2015/03/14/shortcut_add_2.jpg" alt=" "></p>
<h2 id="删除快捷方式">删除快捷方式</h2><p>跟增加快捷方式一样，也是需要增加权限的。加上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.UNINSTALL_SHORTCUT"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>相关代码：<br><img src="https://github.com/waylife/blogimage/raw/master/2015/03/14/shortcut_delete.jpg" alt=" "></p>
<h2 id="快捷方式修改">快捷方式修改</h2><p>需要增加权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果适配所有桌面，请添加附录中第二条所列出的权限。<br>系统并没有提供API去更改桌面快捷方式。只能通过其他猥琐的办法了，可行的的办法之一就是通过ContentProvider去更改数据库相关的信息。当然有人会说了，先删掉快捷方式，再重新创建不就行了？这是个办法。但是有些系统是无法删除快捷方式的；另外，删除快捷方式与创建快捷方式都是通过广播实现的，这个地方需要控制两者的时间间隔。权衡之后，选用第一种办法相对稳妥。<br>废话不多少，上代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">  * 更新桌面快捷方式图标，不一定所有图标都有效&lt;br/&gt;</span><br><span class="line">  * 如果快捷方式不存在，则不更新&lt;br/&gt;.</span><br><span class="line">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateShortcutIcon</span><span class="params">(Context context, String title, Intent intent,Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bitmap==<span class="keyword">null</span>)&#123;</span><br><span class="line">   XLog.i(TAG, <span class="string">"update shortcut icon,bitmap empty"</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">   <span class="keyword">final</span> ContentResolver cr = context.getContentResolver();</span><br><span class="line">   StringBuilder uriStr = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   String urlTemp=<span class="string">""</span>;</span><br><span class="line">   String authority = LauncherUtil.getAuthorityFromPermissionDefault(context);</span><br><span class="line">   <span class="keyword">if</span>(authority==<span class="keyword">null</span>||authority.trim().equals(<span class="string">""</span>))&#123;</span><br><span class="line">    authority = LauncherUtil.getAuthorityFromPermission(context,LauncherUtil.getCurrentLauncherPackageName(context)+<span class="string">".permission.READ_SETTINGS"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   uriStr.append(<span class="string">"content://"</span>);</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(authority)) &#123;</span><br><span class="line">    <span class="keyword">int</span> sdkInt = android.os.Build.VERSION.SDK_INT;</span><br><span class="line">    <span class="keyword">if</span> (sdkInt &lt; <span class="number">8</span>) &#123; <span class="comment">// Android 2.1.x(API 7)以及以下的</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdkInt &lt; <span class="number">19</span>) &#123;<span class="comment">// Android 4.4以下</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher2.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// 4.4以及以上</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher3.settings"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uriStr.append(authority);</span><br><span class="line">   &#125;</span><br><span class="line">   urlTemp=uriStr.toString();</span><br><span class="line">   uriStr.append(<span class="string">"/favorites?notify=true"</span>);</span><br><span class="line">   Uri uri = Uri.parse(uriStr.toString());</span><br><span class="line">   Cursor c = cr.query(uri, <span class="keyword">new</span> String[] &#123;<span class="string">"_id"</span>, <span class="string">"title"</span>, <span class="string">"intent"</span> &#125;,</span><br><span class="line">     <span class="string">"title=?  and intent=? "</span>,</span><br><span class="line">     <span class="keyword">new</span> String[] &#123; title, intent.toUri(<span class="number">0</span>) &#125;, <span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">int</span> index=-<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; c.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    c.moveToFirst();</span><br><span class="line">    index=c.getInt(<span class="number">0</span>);<span class="comment">//获得图标索引</span></span><br><span class="line">    ContentValues cv=<span class="keyword">new</span> ContentValues();</span><br><span class="line">    cv.put(<span class="string">"icon"</span>, flattenBitmap(bitmap));</span><br><span class="line">    Uri uri2=Uri.parse(urlTemp+<span class="string">"/favorites/"</span>+index+<span class="string">"?notify=true"</span>);</span><br><span class="line">    <span class="keyword">int</span> i=context.getContentResolver().update(uri2, cv, <span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">    context.getContentResolver().notifyChange(uri,<span class="keyword">null</span>);<span class="comment">//此处不能用uri2，是个坑</span></span><br><span class="line">    XLog.i(TAG, <span class="string">"update ok: affected "</span>+i+<span class="string">" rows,index is"</span>+index);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    XLog.i(TAG, <span class="string">"update result failed"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; !c.isClosed()) &#123;</span><br><span class="line">    c.close();</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">   ex.printStackTrace();</span><br><span class="line">   XLog.i(TAG, <span class="string">"update shortcut icon,get errors:"</span>+ex.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] flattenBitmap(Bitmap bitmap) &#123;</span><br><span class="line">  <span class="comment">// Try go guesstimate how much space the icon will take when serialized</span></span><br><span class="line">  <span class="comment">// to avoid unnecessary allocations/copies during the write.</span></span><br><span class="line">  <span class="keyword">int</span> size = bitmap.getWidth() * bitmap.getHeight() * <span class="number">4</span>;</span><br><span class="line">  ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream(size);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, out);</span><br><span class="line">   out.flush();</span><br><span class="line">   out.close();</span><br><span class="line">   <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">   XLog.w(TAG, <span class="string">"Could not write icon"</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="快捷方式存在判断">快捷方式存在判断</h2><p>需要增加的权限同修改快捷方式<br>虽然说通过SharePreference来保证快捷方式不会重复创建，以及通过shortcutIntent.putExtra(“duplicate”, false)也可以确保，但是为了万无一失，还是可以通过去查询数据判断快捷方式是否存在，来避免重复创建。   代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">  * 检查快捷方式是否存在 &lt;br/&gt;</span><br><span class="line">  * &lt;font color=red&gt;注意：&lt;/font&gt; 有些手机无法判断是否已经创建过快捷方式&lt;br/&gt;</span><br><span class="line">  * 因此，在创建快捷方式时，请添加&lt;br/&gt;</span><br><span class="line">  * shortcutIntent.putExtra("duplicate", false);// 不允许重复创建&lt;br/&gt;</span><br><span class="line">  * 最好使用&#123;<span class="doctag">@link</span> #isShortCutExist(Context, String, Intent)&#125;</span><br><span class="line">  * 进行判断，因为可能有些应用生成的快捷方式名称是一样的的&lt;br/&gt;</span><br><span class="line">  * 此处需要在AndroidManifest.xml中配置相关的桌面权限信息&lt;br/&gt;</span><br><span class="line">  * 错误信息已捕获&lt;br/&gt;</span><br><span class="line">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isShortCutExist</span><span class="params">(Context context, String title)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="keyword">final</span> ContentResolver cr = context.getContentResolver();</span><br><span class="line">   StringBuilder uriStr = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   String authority = LauncherUtil.getAuthorityFromPermissionDefault(context);</span><br><span class="line">   <span class="keyword">if</span>(authority==<span class="keyword">null</span>||authority.trim().equals(<span class="string">""</span>))&#123;</span><br><span class="line">    authority = LauncherUtil.getAuthorityFromPermission(context,LauncherUtil.getCurrentLauncherPackageName(context)+<span class="string">".permission.READ_SETTINGS"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   uriStr.append(<span class="string">"content://"</span>);</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(authority)) &#123;</span><br><span class="line">    <span class="keyword">int</span> sdkInt = android.os.Build.VERSION.SDK_INT;</span><br><span class="line">    <span class="keyword">if</span> (sdkInt &lt; <span class="number">8</span>) &#123; <span class="comment">// Android 2.1.x(API 7)以及以下的</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdkInt &lt; <span class="number">19</span>) &#123;<span class="comment">// Android 4.4以下</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher2.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// 4.4以及以上</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher3.settings"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uriStr.append(authority);</span><br><span class="line">   &#125;</span><br><span class="line">   uriStr.append(<span class="string">"/favorites?notify=true"</span>);</span><br><span class="line">   Uri uri = Uri.parse(uriStr.toString());</span><br><span class="line">   Cursor c = cr.query(uri, <span class="keyword">new</span> String[] &#123; <span class="string">"title"</span> &#125;,</span><br><span class="line">     <span class="string">"title=? "</span>,</span><br><span class="line">     <span class="keyword">new</span> String[] &#123; title &#125;, <span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; c.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    result = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; !c.isClosed()) &#123;</span><br><span class="line">    c.close();</span><br><span class="line">   &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">   result=<span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span><br><span class="line">  * 不一定所有的手机都有效，因为国内大部分手机的桌面不是系统原生的&lt;br/&gt;</span><br><span class="line">  * 更多请参考&#123;<span class="doctag">@link</span> #isShortCutExist(Context, String)&#125;&lt;br/&gt;</span><br><span class="line">  * 桌面有两种，系统桌面(ROM自带)与第三方桌面，一般只考虑系统自带&lt;br/&gt;</span><br><span class="line">  * 第三方桌面如果没有实现系统响应的方法是无法判断的，比如GO桌面&lt;br/&gt;</span><br><span class="line">  * 此处需要在AndroidManifest.xml中配置相关的桌面权限信息&lt;br/&gt;</span><br><span class="line">  * 错误信息已捕获&lt;br/&gt;</span><br><span class="line">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isShortCutExist</span><span class="params">(Context context, String title, Intent intent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">   <span class="keyword">final</span> ContentResolver cr = context.getContentResolver();</span><br><span class="line">   StringBuilder uriStr = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   String authority = LauncherUtil.getAuthorityFromPermissionDefault(context);</span><br><span class="line">   <span class="keyword">if</span>(authority==<span class="keyword">null</span>||authority.trim().equals(<span class="string">""</span>))&#123;</span><br><span class="line">    authority = LauncherUtil.getAuthorityFromPermission(context,LauncherUtil.getCurrentLauncherPackageName(context)+<span class="string">".permission.READ_SETTINGS"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   uriStr.append(<span class="string">"content://"</span>);</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(authority)) &#123;</span><br><span class="line">    <span class="keyword">int</span> sdkInt = android.os.Build.VERSION.SDK_INT;</span><br><span class="line">    <span class="keyword">if</span> (sdkInt &lt; <span class="number">8</span>) &#123; <span class="comment">// Android 2.1.x(API 7)以及以下的</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdkInt &lt; <span class="number">19</span>) &#123;<span class="comment">// Android 4.4以下</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher2.settings"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// 4.4以及以上</span></span><br><span class="line">     uriStr.append(<span class="string">"com.android.launcher3.settings"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uriStr.append(authority);</span><br><span class="line">   &#125;</span><br><span class="line">   uriStr.append(<span class="string">"/favorites?notify=true"</span>);</span><br><span class="line">   Uri uri = Uri.parse(uriStr.toString());</span><br><span class="line">   Cursor c = cr.query(uri, <span class="keyword">new</span> String[] &#123; <span class="string">"title"</span>, <span class="string">"intent"</span> &#125;,</span><br><span class="line">     <span class="string">"title=?  and intent=?"</span>,</span><br><span class="line">     <span class="keyword">new</span> String[] &#123; title, intent.toUri(<span class="number">0</span>) &#125;, <span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; c.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    result = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; !c.isClosed()) &#123;</span><br><span class="line">    c.close();</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">   result=<span class="keyword">false</span>;</span><br><span class="line">   ex.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="兼容与注意事项">兼容与注意事项</h1><h2 id="兼容">兼容</h2><p>所有的快捷方式Intent如果不是之前版本的存在很大问题，绝对不要改变参数，否则升级或者降级时快捷方式会出现问题；<br>同时，尽可能的采用隐式调用，自定义CATEGORY，而不是自定义ACTION，ACTION参数一定要为ACTION_MAIN，否则有些手机在卸载时无法删除快捷方式（WTF）。</p>
<h2 id="注意事项">注意事项</h2><ul>
<li>【所有】activity路径的变更导致老版本升级之后快捷方式无法使用<br>–&gt; 1.一旦使用确定了activity的包路径，之后就不要再变更；<br>–&gt; 2.尽可能使用隐式调用，但是如果之前已经发出去的版本，为了兼容性，就必须一直使用老的方式，新版本的尽可能的不要更改方式，如果用户降级，老版本快捷方式会无法使用。  </li>
<li>【部分】多个快捷方式指向一个activity导致部分手机（三星SII）升级时图标变成应用图标<br>–&gt; 尽可能的避免多个快捷方式指向同一个activity，可能通过多个activity再跳转过去  </li>
<li>【部分】应用删除时无法删除快捷方式。与系统桌面Launcher实现有关。<br>–&gt; 为了适配所有Launcher，Intent Action使用Intent.ACTION_MAIN。如果是隐式调用，尽可能自定义CATEGORY，而不是自定义ACTION。  </li>
<li>【部分】应用升级时需要删除老版本部分快捷方式，但是部分手机无法删除<br>–&gt; 无解  </li>
<li>【部分】第三方桌面无法生成、删除、更新快捷方式<br>–&gt; 呵呵，一般来说生成没有问题，但是删除，更新大部分桌面会有问题。尽可能避免这些操作。或者专门适配该桌面，成本较高。  </li>
<li>【部分】部分桌面无法实时更新图标，需要重启<br>–&gt; 无解，尝试过重启Launcher，但是结果是之前的快捷方式也消失了。只有重启手机，按理来说应该是有方式触发Launcher进行刷新的。<br>以上【所有】【部分】，分别表示必定出现，部分出现。  </li>
</ul>
<h1 id="参考">参考</h1><ol>
<li><a href="http://grepcode.com/search/?query=InstallShortcutReceiver" target="_blank" rel="external">http://grepcode.com/search/?query=InstallShortcutReceiver</a></li>
<li><a href="http://developer.android.com/index.html" target="_blank" rel="external">http://developer.android.com/index.html</a></li>
</ol>
<h1 id="附录">附录</h1><ol>
<li>完整代码可参考<br><a href="https://gist.github.com/waylife/437a3d98a84f245b9582" target="_blank" rel="external">https://gist.github.com/waylife/437a3d98a84f245b9582</a></li>
<li>通用更新快捷方式权限列表<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.launcher2.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.launcher2.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.launcher3.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.launcher3.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adw.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adw.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.htc.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.htc.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.qihoo360.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.qihoo360.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.lge.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.lge.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"net.qihoo.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"net.qihoo.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adwfreak.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adwfreak.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adw.launcher_donut.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"org.adw.launcher_donut.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.launcher3.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.launcher3.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.fede.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.fede.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.sec.android.app.twlauncher.settings.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.sec.android.app.twlauncher.settings.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.anddoes.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.anddoes.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.tencent.qqlauncher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.tencent.qqlauncher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.launcher2.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.launcher2.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.mylauncher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.android.mylauncher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.ebproductions.android.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.ebproductions.android.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.oppo.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.oppo.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.android.launcher.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"com.huawei.android.launcher.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"telecom.mdesk.permission.READ_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"telecom.mdesk.permission.WRITE_SETTINGS"</span> /&gt;</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">"dianxin.permission.ACCESS_LAUNCHER_DATA"</span> /&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2015/03/14/android-shortcut-summary/#disqus_thread</comments>
    </item>
    
    <item>
      <title><![CDATA[Pacman主题下给Hexo增加简历类型]]></title>
      <link>http://blog.zanlabs.com/2015/01/02/add-resume-type-to-hexo-under-pacman-theme/</link>
      <guid>http://blog.zanlabs.com/2015/01/02/add-resume-type-to-hexo-under-pacman-theme/</guid>
      <pubDate>Fri, 02 Jan 2015 15:23:59 GMT</pubDate>
      <description>
      <![CDATA[<h1 id="背景">背景</h1><p>虽然暂时不找工作，但是想着简历也是个向别人推销自己的好东西。然后也想着折腾点新的东西，如此，这般，便想着研究起写个简历了。<br>形式不限，但是必须是在线的，最好是很简洁的。</p>
<h1 id="分析">分析</h1><p>既然是在]]>
      </description>
      <content:encoded><![CDATA[<h1 id="背景">背景</h1><p>虽然暂时不找工作，但是想着简历也是个向别人推销自己的好东西。然后也想着折腾点新的东西，如此，这般，便想着研究起写个简历了。<br>形式不限，但是必须是在线的，最好是很简洁的。</p>
<h1 id="分析">分析</h1><p>既然是在线的，那就干脆直接用博客呗，直接放在上面。<br>写博客既然用Markdown，那简历也直接用Markdown，一个是可以在线渲染，另外一个是生成PDF的工具也很多，Github一搜就有好几个不错的。<br>由于用的主题是<a href="https://github.com/A-limon/pacman" target="_blank" rel="external">Pacman</a>,那就在它的基础上直接改。虽然网页相关基础只是了解一些，但是并不妨碍修改。<br>先看下最终的效果吧。<a href="/resume">简历效果</a>。  是不是很简洁，达到了预期的效果。嘿嘿。  </p>
<h1 id="实现">实现</h1><p>hexo的主题是放在themes目录下的。先从<a href="https://github.com/A-limon/pacman" target="_blank" rel="external">Pacman</a>下载Pacman主题。下载完成后参考官方说明设置主题为它。<br>接着就开始动工了。</p>
<p>既然是简历嘛，那就不希望它出现在首页的列表里面。也就是md文件不要放在/source/_posts文件夹。建一个about的文件夹，放在/source/about里面。<br>然后新建一个resume.md文件。<br>注意，这个地方我遇到了一个坑，由于md是自己写的，不是hexo自动生成的，导致date后面那行的”—“（三个-）没写，然后后面就坑爹了，死活生成不了正常的页面，同时顶部的键值对冒号之间注意要加空格，很多这种坑。<br>然后一切按照正常的流程走，把简历也写好。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">title: Resume  </span><br><span class="line">layout: post  </span><br><span class="line">date: <span class="number">2015</span>-<span class="number">01</span>-<span class="number">02</span> <span class="number">23</span>:<span class="number">23</span>:<span class="number">59</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># 王小二(wangxiaoer#gmail.com)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 个人信息</span></span><br><span class="line"></span><br><span class="line"> - 本科/XXX大学(<span class="number">20</span>XX.<span class="number">9</span>-<span class="number">20</span>XX.<span class="number">7</span>)/计算机科学与技术</span><br><span class="line"> - 工作年限：<span class="number">2</span>年</span><br><span class="line"> - 技术博客：http://xxxxx.com</span><br><span class="line"> - 地点：北京</span><br><span class="line"></span><br><span class="line"><span class="comment">## 工作经历</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 五道口宇宙中心</span></span><br><span class="line"><span class="comment">#### XXXX项目（2013.10-至今）</span></span><br><span class="line"> - XXXXXXXXXXXXXXXXX</span><br><span class="line"> - XXXXXXXXXXXXXXXXXX</span><br><span class="line"> - XXXXXXX</span><br><span class="line"> - XXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 技能列表</span></span><br><span class="line">熟悉：Android/Java</span><br><span class="line">了解：C<span class="comment">#/WP，Python，HTML, Markdown等</span></span><br></pre></td></tr></table></figure>
<p>现在看起来跟Pacman主题下任何普通的博文样式一样。<br>现在怎么去掉首部，以及尾部，以及侧边栏等等一切不要的东西，不要捉急，慢慢来，一个一个砍，一步一步实现咱们想要的效果。<br>看到md首部有个layout属性，是不是可以从这里开刀呢？<br>再联想到Pacman配置搜索页面需要设置layout属性为search。OK，就以search为关键词在pacman中搜索，然后在/pacman/layout/layout.ejs里面找到了它。这种关键词查找突破法在很多地方可以用到。之前研究别人APK实现原理的时候就经常用，屡试不爽，下次写文章讲解APK的逆向研究。<br>OK，找到了。发现里面大致的一段代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;% &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.layout==<span class="string">'search'</span>)&#123; %&gt;</span><br><span class="line"> &lt;%- partial(<span class="string">'_partial/head'</span>) %&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">      &lt;header&gt;</span><br><span class="line">        &lt;%- partial(<span class="string">'_partial/header'</span>) %&gt;</span><br><span class="line">      &lt;/header&gt;</span><br><span class="line">      &lt;div id=<span class="string">"container"</span>&gt;</span><br><span class="line">        &lt;%- partial(<span class="string">'_partial/search'</span>)%&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;%- partial(<span class="string">'_partial/after_footer'</span>) %&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>想起之前学习php时也会有这种混用，html代码与php代码混在在一起，这里应该也是差不多的。暂时先这样认为，当然后续也证实了这是没错的。<br>既然pacman可以自定义search属性，那咱们也可以自定义一个resume属性。   那里面要放什么内容呢？ 跟search节点一样？<br>然后查看hexo主题属性layout相关的文档<a href="http://hexo.io/docs/themes.html#Layout" target="_blank" rel="external">http://hexo.io/docs/themes.html</a>，里面说一个布局必须包含”&lt;%- body %&gt; “才能显示内容。<br>常用的是layout值是post或者page，先看下page果然有”&lt;%- body %&gt; “，那就考虑直接复制过来，用了再说。post与page的区别通过测试可以发现post右边有Sidebar，样式也有一定区别。鉴于实际情况，此处使用page的内容。<br>改好之后就直接运行看效果了，尼玛，背景是灰色的啊，不能忍啊，太tm难看了。page类型的就是白色的，然后使用Chrome审查元素，看到内容的class id为resume，page的为page，应该跟这个有关系，然后搜索，找到了/pacman/source/css/_partial/article.styl。第一行加上,.resume，一切搞定。<br>接着就是怎么搞定首部和尾部了。看到layout文件里里面有个page.ejs文件，先拷贝一份为resume.ejs（处理页面数据）,/_partial文件夹里面的也类似（这个用来处理往首页列表加摘要）。这个文件里面使用到的/_partial/post/article.ejs也拷贝一份为resume.js。修改/layout/resume.ejs文件里面的指向。<br>由于不需要评论以及尾部，删除/_partial/post/article.ejs底部的一些数据，最终代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"main"</span> class=<span class="string">"&lt;%= item.layout %&gt;"</span> itemscope itemprop=<span class="string">"blogPost"</span>&gt;</span><br><span class="line">  &lt;article itemprop=<span class="string">"articleBody"</span>&gt;</span><br><span class="line">    &lt;%- partial(<span class="string">'header'</span>) %&gt;</span><br><span class="line">  &lt;div class=<span class="string">"article-content"</span>&gt;</span><br><span class="line">    &lt;%- partial(<span class="string">'gallery'</span>) %&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span>( table&amp;&amp;(item.toc !== <span class="literal">false</span>) &amp;&amp; theme.toc.article)&#123; %&gt;</span><br><span class="line">    &lt;div id=<span class="string">"toc"</span> class=<span class="string">"toc-article"</span>&gt;</span><br><span class="line">      &lt;strong class=<span class="string">"toc-title"</span>&gt;&lt;%= __(<span class="string">'contents'</span>) %&gt;&lt;/strong&gt;</span><br><span class="line">    &lt;%- toc(item.content) %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    &lt;%- item.content %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;/article&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后回到/_partial/post/article.ejs里面的resume分支，之前复制的是page代码，我们需要删掉一些数据，考虑只留下”&lt;%- body %&gt; “，运行一下，卧槽，怎么会有乱码。应该是头部有编码信息，要考虑保留，尾部由于也有统计信息，也要考虑保留，最后经过不断的”删除-&gt;查看效果-&gt;复原”，确定删除的部分，最终保留代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;% &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.layout==<span class="string">'resume'</span>)&#123; %&gt;</span><br><span class="line">  &lt;% <span class="keyword">if</span>(page.source.match(/\.md$/))&#123; %&gt;</span><br><span class="line">   &lt;%- partial(<span class="string">'_partial/head'</span>) %&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">       &lt;div id=<span class="string">"container"</span>&gt;</span><br><span class="line">         &lt;%- body %&gt;</span><br><span class="line">       &lt;/div&gt;</span><br><span class="line">      &lt;div id=<span class="string">"footer"</span>&gt;&lt;br/&gt;&lt;/div&gt;</span><br><span class="line">       &lt;%- partial(<span class="string">'_partial/after_footer'</span>) %&gt;</span><br><span class="line">     &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line">    &lt;% &#125;<span class="keyword">else</span>&#123; %&gt;</span><br><span class="line">   &lt;%- page.content %&gt;</span><br><span class="line"> &lt;% &#125; %&gt;</span><br><span class="line">&lt;% &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.layout==<span class="string">'page'</span>)&#123; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>最后运行一下，就是之前的效果了。Perfect！<br>最后编写简历时把layout设置为resume就可以了。同时，最好不要把简历的md放在_posts目录下，如果放在里面，在首页列表里面会包含有它，而且样式有一定问题。/about/resume.md最后生成的路径是 <a href="http://yourwebsite/about/resume.html" target="_blank" rel="external">http://yourwebsite/about/resume.html</a> ，然后在首页的顶部导航栏增加这个路径就可以了。</p>
<h1 id="总结">总结</h1><p>不仅仅可以增加resume属性，也可以增加其他的来扩展更多的自定义页面，比如404页面。<br>花了一晚上时间研究，虽然在—三个-处耽误了不少时间，还是蛮有趣的。<br>有任何问题欢迎向我反馈。<br>源码我已经放在<a href="https://github.com/waylife/pacman_with_resume" target="_blank" rel="external">Github</a>上了，欢迎star以及fork。  </p>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2015/01/02/add-resume-type-to-hexo-under-pacman-theme/#disqus_thread</comments>
    </item>
    
    <item>
      <title><![CDATA[Python抓取单个网页中所有的PDF文档]]></title>
      <link>http://blog.zanlabs.com/2014/11/11/python-webpage-crawling/</link>
      <guid>http://blog.zanlabs.com/2014/11/11/python-webpage-crawling/</guid>
      <pubDate>Tue, 11 Nov 2014 13:49:53 GMT</pubDate>
      <description>
      <![CDATA[<h1 id="1-背景">1.背景</h1><p>最近发现算法以及数据结构落下了不少（其实还是大学没怎么好好学，囧rz），考虑到最近的项目结构越来越复杂了，用它来练练思路，就打算复习下数据结构与算法。结合最近在学英语，然后干脆就用英文喽。然后选定一本参考书籍《Data Stru]]>
      </description>
      <content:encoded><![CDATA[<h1 id="1-背景">1.背景</h1><p>最近发现算法以及数据结构落下了不少（其实还是大学没怎么好好学，囧rz），考虑到最近的项目结构越来越复杂了，用它来练练思路，就打算复习下数据结构与算法。结合最近在学英语，然后干脆就用英文喽。然后选定一本参考书籍《Data Structures and Algorithms in Java》。<br>刚开始看还是蛮吃力的，慢慢来。由于之前有翻录书籍附录的习惯，于是就去书籍附带的官网看了下，发现<a href="http://ww0.java4.datastructures.net/handouts/" target="_blank" rel="external">http://ww0.java4.datastructures.net/handouts/</a> 里面附带的PDF文档居然不错，图文并茂，作为理解是个不错的材料，果断要下载啊。但是，尼玛，结果发现，好多个，这一个一个另存为真是要命，想想还是用什么办法下载下来吧。</p>
<h1 id="2-实现">2.实现</h1><p>考虑目前学过的了解的所有语言，可以用来实现的，排列一下程度：</p>
<ol>
<li>Java/Android  熟悉</li>
<li>C# 熟悉</li>
<li>Python 了解语法</li>
<li>Javascript 了解一些  </li>
<li>C/C++ 了解语法</li>
</ol>
<p>为了实现这个，当然是最简单最快最好了。考虑到大学一直用C#，要不用它？但发现OSX平台只能用Mono了，还得重新熟悉。Java实现也不快，从需要的时间考虑。Javascript不熟，貌似可以用node.js去写(atom就是用的它)。不熟。C/C++好多年没用过了，而且，实现起来代码一大堆，特别麻烦。再考虑之前一段时间正好在Codecademy学过语法，就拿它来练手吧。<br>OK，确定了用Python。后续就是怎么去请求网络了，解析网页html标签，提取下载链接，下载文件了。虽然不懂这些在Python里面是怎么实现的，但是流程是确定的，按照流程去网站找现成的，此处不研究原理，实现功能即可。<br>接下来就是各种搜索引擎搜索东西了，Google可，百度亦可（不同引擎侧重不一样）。不要忘了目的是什么，搜索相关的资料。<br>好了，搜索之后，确定请求网络下载网页用requests，解析html用BeautifulSoup，提取下载链接BeautifulSoup，下载文档（stackoverflow中找到了一段下载文件的代码）。<br>然后就是把她们一起组合了。组合之后的代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#file-name: pdf_download.py</span></span><br><span class="line">__author__ = <span class="string">'rxread'</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_file</span><span class="params">(url, index)</span>:</span></span><br><span class="line">    local_filename = index+<span class="string">"-"</span>+url.split(<span class="string">'/'</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># NOTE the stream=True parameter</span></span><br><span class="line">    r = requests.get(url, stream=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">with</span> open(local_filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> r.iter_content(chunk_size=<span class="number">1024</span>):</span><br><span class="line">            <span class="keyword">if</span> chunk: <span class="comment"># filter out keep-alive new chunks</span></span><br><span class="line">                f.write(chunk)</span><br><span class="line">                f.flush()</span><br><span class="line">    <span class="keyword">return</span> local_filename</span><br><span class="line"></span><br><span class="line"><span class="comment">#http://ww0.java4.datastructures.net/handouts/</span></span><br><span class="line">root_link=<span class="string">"http://ww0.java4.datastructures.net/handouts/"</span></span><br><span class="line">r=requests.get(root_link)</span><br><span class="line"><span class="keyword">if</span> r.status_code==<span class="number">200</span>:</span><br><span class="line">    soup=BeautifulSoup(r.text)</span><br><span class="line">    <span class="comment"># print soup.prettify()</span></span><br><span class="line">    index=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> soup.find_all(<span class="string">'a'</span>):</span><br><span class="line">        new_link=root_link+link.get(<span class="string">'href'</span>)</span><br><span class="line">        <span class="keyword">if</span> new_link.endswith(<span class="string">".pdf"</span>):</span><br><span class="line">            file_path=download_file(new_link,str(index))</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"downloading:"</span>+new_link+<span class="string">" -&gt; "</span>+file_path</span><br><span class="line">            index+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"all download finished"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"errors occur."</span></span><br></pre></td></tr></table></figure></p>
<p>运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pdf_download.py</span><br></pre></td></tr></table></figure></p>
<p>便可以把所有的pdf文档下载到本地。</p>
<h1 id="3-优化">3.优化</h1><p>30多行代码，全部搞定，真是简洁明了，果然做Python用来一些脚本任务还是不错的。利用它下载了41个文档。<br>最开始下载下来的文档没有序号，这样看的时候就不知道先后，于是我给文件名前面加了个序号。<br>其他的优化部分可以参考如下：</p>
<ol>
<li>考虑现在函数的一些异常出错没有处理，后续需要处理。</li>
<li>函数没有完全封装，下载的文件类型支持不多，这个后续可以根据自己的需求进行扩展。  </li>
<li>下载的文件少的时候可能这样就行了，但是文件多的话，是有必要使用多个线程（适量的数量）或者线程池去下载，从而加快下载速度。  </li>
<li>有些写法可能不符合python语法规范，当然写了与没写已经是0和1的区别了。</li>
<li>其他细节，比如pdf有可能是大写的PDF。  </li>
</ol>
<h1 id="4-附录">4.附录</h1><ol>
<li>《Data Structures and Algorithms in Java》(Michael T. Goodrich, Roberto Tamassia)下载 <a href="http://bookzz.org/" target="_blank" rel="external">http://bookzz.org/</a> 或者 <a href="http://it-ebooks.info/" target="_blank" rel="external">http://it-ebooks.info/</a><br>以下两个网站都是不错的书籍下载网站，有条件还是买本正版书籍支持一下作者吧。<br>一般我会先下载电子书看下，合适就买纸质版。  </li>
<li>Python语法入门 <a href="http://www.codecademy.com/zh/tracks/python" target="_blank" rel="external">http://www.codecademy.com/zh/tracks/python</a>  </li>
</ol>
<p>以上，便是如此了。  </p>
<p>本文来自<a href="&quot;http://waylife.github.io&quot;">RxRead’s Blog</a>,欢迎转载，转载请注明。<br>欢迎一起交流探讨。</p>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2014/11/11/python-webpage-crawling/#disqus_thread</comments>
    </item>
    
    <item>
      <title><![CDATA[应用市场高速下载以及网页端调起APP页面研究与实现]]></title>
      <link>http://blog.zanlabs.com/2014/10/27/appmall-highspeeddownload-and-app-invoke/</link>
      <guid>http://blog.zanlabs.com/2014/10/27/appmall-highspeeddownload-and-app-invoke/</guid>
      <pubDate>Mon, 27 Oct 2014 15:05:53 GMT</pubDate>
      <description>
      <![CDATA[<p>好久没写博客了，好大一个坑。正好，最近刚做完应用市场的高速下载功能，便拿来填了这个坑。<br>话说产品为了增加用户量，提升用户活跃度以及配合推广，更坑爹的是看到其他市场也有这些功能，等等，要求做一个捆绑下载的功能。WTF。<br>当然吐槽归吐槽，任务还是要完成的。<br>具]]>
      </description>
      <content:encoded><![CDATA[<p>好久没写博客了，好大一个坑。正好，最近刚做完应用市场的高速下载功能，便拿来填了这个坑。<br>话说产品为了增加用户量，提升用户活跃度以及配合推广，更坑爹的是看到其他市场也有这些功能，等等，要求做一个捆绑下载的功能。WTF。<br>当然吐槽归吐槽，任务还是要完成的。<br>具体要求是：<br>用户在手机浏览WAP站点的时候，<del><strong><em>1.进入应用详情页时打开本应用(应用市场)里面的详情页面 2.点击WAP端高速下载时，如果本应用已安装，则调用本应用进行下载，否则下载本应用的捆绑包，安装完成之后，在本应用打开时去下载之前用户想下载的应用。</em></strong></del><br>如何实现这两个功能呢？以下逐步分析：  </p>
<h1 id="1-功能需求">1.功能需求</h1><p>如之前所描述。<br>一般来说，完成之前的两个功能，一般都是需要应用已安装并且在后台运行(最简单的理解就是应用打开过应用，并且没有被其他程序杀死)，因此此处也默认这种情形才算应用已安装；否则，一概认为是未安装（以下没有特别说明，均为这种情况）。</p>
<h1 id="2-竞品分析">2.竞品分析</h1><p>当然，既然竞品有了这些功能，那就先拿来主义，研究下他们是怎么做的吧。通过Chrome抓包分析，最后分析如下。  </p>
<ul>
<li>百度手机助手 <a href="http://127.0.0.1:6259/***" target="_blank" rel="external">http://127.0.0.1:6259/***</a>  </li>
<li>搜狗手机助手 <a href="http://127.0.0.1:12388/***" target="_blank" rel="external">http://127.0.0.1:12388/***</a></li>
<li>豌豆荚 自定义协议wandoujia://detail/app/cn.buding.martin<br>百度手机助手以及搜狗手机助手的方案基本是一致的，<del><strong><em>采用的是访问一个手机本地服务地址127.0.0.1（回环地址）,端口地址有所不同</em></strong></del>，豌豆荚采用的是自定义协议，后续让浏览器自动帮它分发给注册了wandoujia协议的Activity。</li>
</ul>
<hr>
<ol>
<li><strong>打开应用详情</strong> 这个在打开浏览器相应详情页面时，百度手机助手以及搜狗手机助手同时访问本地回环地址，而豌豆荚则调用自定义协议由系统调用相关的应用（一般就是豌豆荚）。  </li>
<li><strong>高速下载原理</strong> 豌豆荚没有实现在应用已安装情形下调用客户端进行下载，在点击下载时，询问用是下载捆绑包还是直接下载想要下载的应用（描述文案见文末附图，文案有诱导性）。选择下载捆绑包，则下载一个特定文件名的豌豆荚安装包。在安装完成之后，去扫描特定的目录（一般是download以及常见浏览器的下载目录），如果存在符合规则的文件，则提取相关的资源ID，后续再下载捆绑的APP。<br>在应用没有安装的情形下。而百度手机与搜狗手机助手点击高速下载（名字也有诱导），则直接下载一个APP，所有APP内容一样，但是APP名字有所不同，均类似于app_捆绑id_xx.apk，比如搜狗手机助手捆绑微信的为MobileTools_8271386494777466339_71.apk，捆绑其他包的捆绑id有所不同。其他流程同豌豆荚。如果存在多个符合条件的apk，搜狗手机助手则取最新的信息进行下载，百度手机助手没有研究。<br>如果手机APP已经安装。豌豆荚没有实现，而百度手机助手以及搜狗手机助手，则是浏览器网页直接请求一个回环地址(127.0.0.1:port/actionpath?parameter)，port为端口地址，百度手机助手为6259，搜狗手机助手为12388。actionpath为需要进行的操作，不同的操作，值也不一致 parameter为相关操作的参数，在这里把需要捆绑下载的APP数据传过去。手机APP通过应用内的HTTP服务器接收到相关数据后进行应用下载，同时返回相应的数据。  </li>
</ol>
<h1 id="3-最后方案">3.最后方案</h1><p><strong>调起详情页面</strong>，采用HTTP服务器以及自定义协议两种都可以，而且自定义协议不用一直在后台跑一个承载HTTP服务器的Service，会比较省电。<br>后续的<strong>高速下载</strong>，豌豆荚是没有了，既然之前说到自定义协议省电，能否考虑呢？再结合需求，看下，应用未安装的情形下，直接下载捆绑包，两种都没有问题；应用已安装的情形，调起客户端进行下载。自定义协议可以做到么？如何知道应用是否安装了呢？浏览器有相应的API么？显然没有，就算有，也只可能部分有，但是要支持所有的浏览器。唯一的办法就是通过访问HTTP服务器，同时设置超时时间，一定时候内没有响应则认为应用未安装，下载相应的捆绑包。而且，通过HTTP服务器后续扩展也好，可以通过网页服务器与Web进行双向互动，比如百度手机助手可以通过web获得位置信息。而自定义协议就显然做不到这些。当然除了省电。<br>高速下载的调起解决了，那如果应用没有安装，在本应用安装完成之后，如何知道之前用户需要下载的是哪个应用呢？也就是<strong>捆绑应用的识别</strong>。<br>应用市场最开始的方案是在应用里面（asset文件夹下）打入一个文件，存放有捆绑应用的id号。但是，针对少量应用可以（最开始为了测试捆绑效果时用过），目前来说，针对大量应用肯定不行，需要打大量的包，而且需要不少存储空间。<br>参考竞品的方案，确实很完美，但是，考虑目前大部分的手机安全或者清理软件，都会在应用安装成功后提示删除安装包，同时，浏览器的下载目录可能会会变。那这里能扫描整个SD卡，去寻找符合条件的文件么？肯定不行，太消耗时间了。<br>那在应用没有安装或者没有在后台运行的情形下，如何知道捆绑的应用id呢。以上两个方案都不完美，如何解决。与后端彦飞探讨过，在高速下载apk时，网页记录手机下载的捆绑app id以及packagename以及该设备的唯一id（uuid），然后在打开市场时，请求相应的接口并把uuid传入，获得数据，从而下载相应的应用。想法超赞，后来发现没有实用价值，uuid暂时没有一个合理的方案。关键在于两端生成的都要唯一，mac，ip？如何生成？<br>后来吃饭与国畅探讨后，考虑是不是可以调用本地代码去执行相关任务？但仔细思考过后，发现这个一般是WebView与js进行交互。而目前的使用场景根本就无法做到。这个Webview必须要是自己应用内的才可以。<br>考虑多方面因素，最后决定，参考百度手机助手以及搜狗手机助手的方案，尽管有缺陷。<br>关于自定义协议模式，可参考此文章，<a href="http://www.oschina.net/code/snippet_256033_35330" target="_blank" rel="external">android自定义协议和html加载时自动尝试调用本地APP</a>，以及<a href="http://www.pocketdigi.com/20101002/117.html" target="_blank" rel="external">Android 注册监听自定义协议</a>，本文不做过多介绍。<br><del><strong><em>最后的方案就是手机端后台通过Service运行一个HttpServer，监听12307端口。</em></strong></del></p>
<h2 id="调起客户端">调起客户端</h2><h3 id="1-高速下载">1.高速下载</h3><p>网页端点击高速下载时，访问<a href="http://127.0.0.1:12307/appdown?downid=1&amp;packagename=com.sogou.map" target="_blank" rel="external">http://127.0.0.1:12307/appdown?downid=1&amp;packagename=com.sogou.map</a><br>如果成功，返回json串形式为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"status"</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="string">"message"</span>:<span class="string">"OK"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>status为0表示失败，status为1表示成功。message为具体描述。<br>如果在一定时间内手机没有响应，则默认应用没有安装，下载捆绑APK包。<br>如果手机端响应了，则网页端不做任何处理，手机端获得相应的downid以及packagename，先判断应用是否已经安装，如果安装，则提示应用已安装，如果未安装，则提示用户应用正在下载，然后加入下载列表。  </p>
<h3 id="2-打开详情页面">2.打开详情页面</h3><p><a href="http://127.0.0.1:12307/godetail?downid=1&amp;packagename=com.sogou.map&amp;backtohome=ture" target="_blank" rel="external">http://127.0.0.1:12307/godetail?downid=1&amp;packagename=com.sogou.map&amp;backtohome=ture</a><br>backtohome为true时，按下手机端的返回按钮回到应用的主页，为false时返回浏览器。（可参考豌豆荚，比如<a href="http://www.wandoujia.com/apps/com.tencent.mm" target="_blank" rel="external">http://www.wandoujia.com/apps/com.tencent.mm</a>必须手机端访问，User-Agent与PC访问不同）  </p>
<h2 id="安装包应用捆绑">安装包应用捆绑</h2><p>如何识别捆绑的是哪个应用呢？<br>后续参考竞品的实现方式，通过下载文件名不同（文件名有规则）的文件，在用户安装应用并且打开后去读取下载文件夹，判断是否存在符合规则的apk。如果存在，提取相应的id，去进行相应的下载。只要服务器提供接口让浏览器在下载同一个文件显示为不同的文件名即可。<br>比如搜狗手机助手的一个微信详情地址为<a href="http://wap.sogou.com/app/apkdetail.jsp?ppid=34&amp;cid=49&amp;docid=8271386494777466339&amp;e=1394" target="_blank" rel="external">http://wap.sogou.com/app/apkdetail.jsp?ppid=34&amp;cid=49&amp;docid=8271386494777466339&amp;e=1394</a>，高速下载安装包的地址是<a href="http://download.zhushou.sogou.com/zhushou/android/MobileTools.apk?dn=MobileTools_8271386494777466339_71.apk" target="_blank" rel="external">http://download.zhushou.sogou.com/zhushou/android/MobileTools.apk?dn=MobileTools_8271386494777466339_71.apk</a><br>下载下来的apk名称为MobileTools_8271386494777466339_71.apk。捆绑的应用id为8271386494777466339，应用为微信。通过设置HTTP返回数据的headers的<code>Content-Disposition</code>字段为<code>attachment;filename=&quot;MobileTools_8271386494777466339_71.apk&quot;</code>就可以实现，一般来说，主流浏览器都支持该属性。  </p>
<p>因此，最终确定，APK的命名方式为XXXX_binding_downid_9.apk，判断应用为这种格式（可通过正则匹配）就会提取downid（downid必须为整数）。应用未安装时，点击高速下载，下载以上规则命名的apk到文件夹。用户安装应用并打开应用时，去扫描常用的下载文件夹（常见的/download,/downloads,以及浏览器下载文件夹等）里面的apk，有符合规则的则提取某一个文件中的id，提取完成之后，进行下载，同时把安装包删除（防止对之后进行干扰）。考虑到同一个文件夹可能有多个符合规则的安装包，则按照时间顺序取当前文件夹符合规则的时间最近的两个，其他的文件夹的忽略，等下次启动再处理（一般这种情况也比较少）。当然还有其他一些细节需要处理，此处不再详谈。  </p>
<h1 id="4-性能优化与展望">4.性能优化与展望</h1><p>程序优化，是有追求的攻城师必须做的事情，因此，当然要优化喽。<br>为了省电，指定了以下两条策略。  </p>
<ol>
<li>在网络变化时，如果没有网络，则关闭服务，有网络，则打开服务。解屏以及锁屏时分别打开以及关闭服务。  </li>
<li>有网，且屏幕打开是触发服务开启的必要条件。可以大部分降低应用在锁屏状态下有网络变化而导致的耗电问题。<br>以上两个策略可叠加使用，可能会有些问题，比如有些时候条件都符合，但是服务没有开启（网络十分频繁的切换可能会导致）。<br>设定为以上条件是因为，后续的操作都是有网才能完成，其次，锁屏状态下，一般用户是没办法触发相关的流程的，除非程序自动触发（即时通讯软件接收信息比如，或者自动下载，但是这太流氓了）才需要在锁屏时在后台跑。</li>
</ol>
<p>HTTP服务器是用的Github上开源的<a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="external">Nanohttpd</a>，http服务器除了高速下载，也可以用在，比如传输数据到电脑，应用与网页交互等等很多方面。  </p>
<h1 id="5-最终实现">5.最终实现</h1><p>可访问<a href="http://app.sogou.com/m" target="_blank" rel="external">http://app.sogou.com/m</a> 查看最终效果。<br>大致的思路就是以上描述。希望对大家有所启发，起个抛砖引玉的作用。<br>目前暂时未上线，估计等到11月5号。  </p>
<h1 id="6-相关工具以及附录">6.相关工具以及附录</h1><p>（1）Chrome 开发者工具+设备模式（数据抓包）<br>（2）三个市场的微信下载的演示地址：<a href="http://m.baidu.com/app?action=content&amp;uid=0&amp;from=844b&amp;ssid=0&amp;bd_page_type=1&amp;pu=sz@1320_224#docid=7106818&amp;ala=se@v@1@3@title&amp;f=aladdin@%E5%BE%AE%E4%BF%A1" target="_blank" rel="external">百度手机助手</a>，<a href="http://wap.sogou.com/app/apkdetail.jsp?ppid=34&amp;cid=49&amp;docid=8271386494777466339&amp;e=1394" target="_blank" rel="external">搜狗手机助手</a>，<a href="http://www.wandoujia.com/apps/com.tencent.mm" target="_blank" rel="external">豌豆荚</a><br>当时（2014-10-27的页面截图如下）<br><img src="https://raw.githubusercontent.com/waylife/blogimage/master/2014/10/binding_app_baidu_sogouzhushou_wandou.jpg" alt="百度手机助手-搜狗手机助手-豌豆荚__微信捆绑下载图"><br>（3）常见浏览器的APK下载路径（#表示该行是注释，每行一个目录，目前不支持遍历子目录）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#this is the binding apk file path</span></span><br><span class="line"><span class="comment">#this is  a comment</span></span><br><span class="line"><span class="comment">#some system default, Chrome, Opera, Opera mini, Sogou Broswer, ES File Explorer,Dolphin Browser</span></span><br><span class="line">download</span><br><span class="line"><span class="comment">#meizu browser, some system default</span></span><br><span class="line">download/apk</span><br><span class="line">downloads</span><br><span class="line"><span class="comment">#vivo</span></span><br><span class="line">下载</span><br><span class="line">下载/App</span><br><span class="line"><span class="comment">#uc browser</span></span><br><span class="line">UCDownloads</span><br><span class="line"><span class="comment">#QQ Broswer</span></span><br><span class="line">QQBrowser/安装包</span><br><span class="line">QQBrowser/下载</span><br><span class="line">qqbrowser/download</span><br><span class="line"><span class="comment">#QQ Broswer HD</span></span><br><span class="line">QQBrowser</span><br><span class="line"><span class="comment">#baidu broswer</span></span><br><span class="line">baidu/flyflow/downloads</span><br><span class="line"><span class="comment">#baidu app</span></span><br><span class="line">baidu/searchbox/downloads</span><br><span class="line"><span class="comment">#Maxthon Broswer</span></span><br><span class="line">MxBrowser/Downloads</span><br><span class="line">TTDownload/installapk</span><br><span class="line">Application</span><br><span class="line">ThunderDownload</span><br><span class="line"><span class="comment">#liebao broswer</span></span><br><span class="line">kbrowser_fast/download/App</span><br><span class="line"><span class="comment">#360 Broswer</span></span><br><span class="line"><span class="number">360</span>Browser/download</span><br><span class="line"><span class="comment">#360 Express Broswer</span></span><br><span class="line"><span class="number">360</span>ExpressBrowser/download</span><br><span class="line"><span class="comment">#2345 broswer</span></span><br><span class="line">Download/<span class="number">2345</span>浏览器下载/安装包</span><br><span class="line"><span class="comment">#hao123</span></span><br><span class="line">hao123/down/apk</span><br><span class="line">DolphinBrowserCN/download</span><br><span class="line">UCDLFiles</span><br><span class="line">QCDownload</span><br><span class="line">LXDOWNLOAD/DOWNLOAD</span><br><span class="line">apc/ApcBrowser/downloads</span><br><span class="line"><span class="comment">#YueDong Broswer,Ignore,The apk file name is changed by the broswer,the same with 4G Explorer(do not support header's Content-Disposition attribute)</span></span><br><span class="line"><span class="comment">#ydBrowser/download</span></span><br><span class="line"><span class="comment">#4G-explorer/apks</span></span><br></pre></td></tr></table></figure></p>
<p>哈哈哈哈，完美解决所有问题。之后还可以扩展。<br><img src="https://github.com/waylife/blogimage/raw/master/common/quick_run.gif" alt=" "><br><img src="https://github.com/waylife/blogimage/raw/master/common/simle_1.gif" alt=""></p>
<h1 id="7-后续">7.后续</h1><p>后续发现知乎上有一篇系统介绍文章<a href="http://zhuanlan.zhihu.com/andlib/19848910" target="_blank" rel="external">http://zhuanlan.zhihu.com/andlib/19848910</a>  </p>
<p>本文来自<a href="http://waylife.github.io" target="_blank" rel="external">RxRead’s Blog</a>,欢迎转载，转载请注明。  </p>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2014/10/27/appmall-highspeeddownload-and-app-invoke/#disqus_thread</comments>
    </item>
    
    <item>
      <title><![CDATA[Hello World]]></title>
      <link>http://blog.zanlabs.com/2014/09/20/hello-world/</link>
      <guid>http://blog.zanlabs.com/2014/09/20/hello-world/</guid>
      <pubDate>Sat, 20 Sep 2014 05:15:15 GMT</pubDate>
      <description>
      <![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io]]>
      </description>
      <content:encoded><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content:encoded>
      <comments>http://blog.zanlabs.com/2014/09/20/hello-world/#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
