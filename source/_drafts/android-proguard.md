title: Android Proguard  
layout: post  
categories: Android
tags: [android,proguard,安全,security]
---

#背景
应用被别人反编译植入广告，而导致本身应用没获得相应的回报确背负骂名。以及付费应用被人破解等等。
针对这些，我们有必要对自己的应用做一些保护，来提高破解难度。  
本文试图从最简单的混淆入手，介绍混淆相关的知识，混淆的常规使用以及引入一些其他的常见的加固手段。  


#原理
##混淆原理
在应用程序保持语句含义不变的前提下从程序P转换到了P'。  　混淆技术是指对拟发布的应用程序进行保持语义的变换,使得变换后的程序和原来的程序在功能上相同或相近,但是更难以被逆向工程所攻击。

##常见方法
- 代码外形混淆（改名）
- 控制命令混淆（改变程序判断条件或者增加可控制条件以及其他对程序的结构以及流程进行调整）
- 内部数据混淆（数据结构的变换，变量的分裂、合并，数据结构变换，静态数据动态生成，类继承转换）
- 预防混淆（增加某些特定反编译反编译时会出错的代码）

##评价指标
- 强度，混淆算法对程序增加的复杂度
- 弹性，混淆后程序的抗机器攻击能力
- 开销，由代码转换带来的额外开销

Proguard一般常用代码外形混淆，也就是常说的名称替换，比如类名、变量名、函数名、包名等变换为符合规则的是否不适合肉眼进行分析的名称。  

#Proguard
##简要语法

##常见使用
##需要注意
以下分为两部分，一部分是官网默认配置的点，一部分非官方说明配置的需要注意的分别进行讲解。
###官方

###非官方

##混淆还原
在需要分析出错日志时，需要对出错日志进行还原来定位出错的类，出错的具体行号。 这时我们就需要利用混淆时生成的mapping.txt文件进行代码还原，从而定位出错代码。
``` bash
retrace.bat|retrace.sh [-verbose] mapping.txt [<stacktrace_file>]
```
比如  
``` bash
retrace.bat -verbose mapping.txt obfuscated_trace.txt
```
当然也可以使用GUI工具进行还原

#安全展望
除了使用混淆，目前对于企业以及开发者不增加太多成本的另外一个方式就是使用第三方的加密工具。  
比如爱加密，帮帮加固，360应用加固等等。  
常见的加固原理是对dex进行加密，在运行时再进行解密。而正是由于这个，导致程序运行效率较低。同时，由于Android 5.0在应用安装完成后对加密dex文件进行了处理，导致程序后续无法运行，也就是说部分加固的程序在5.0之后无法运行。  
当然，不排除特定加固厂商已解决此问题。
常见的一般是必须混淆，加固一般不会大量使用，如果使用，请在各个版本以及大量机型测试通过后再使用。
如果应用需要加固同时需要打多个渠道包，可参考我之前在知乎的回答http://www.zhihu.com/question/31439207/answer/51972925  

#高级使用Proguard
让程序名称使用我们自定义的名称

#参考

1. http://proguard.sourceforge.net/
2. http://developer.android.com/tools/help/proguard.html
3. [Android程序破解与保护浅析]( http://www.cnblogs.com/waylife/p/3675684.html)
